#include <BleKeyboard.h>
#include <TFT_eSPI.h>
#include <RotaryEncoder.h>

// 1. Initialization
BleKeyboard bleKeyboard("Media Deck", "Maker Name", 100);
TFT_eSPI display = TFT_eSPI();

// Define pins for Encoder, its button (SW), and the 3 media buttons
RotaryEncoder encoder(ENCODER_CLK_PIN, ENCODER_DT_PIN, RotaryEncoder::LatchMode::FOUR3);
const int ENCODER_SW_PIN = 10;
const int BTN_NEXT_PIN = 11;
const int BTN_PREV_PIN = 12;
const int BTN_PAUSE_PIN = 13;

void setup() {
    // Start Bluetooth
    bleKeyboard.begin();
    // Initialize Display
    display.init();
    display.fillScreen(TFT_BLACK);
    display.setRotation(1); 
    // Initialize Encoder Pins
    pinMode(ENCODER_SW_PIN, INPUT_PULLUP);
    // Initialize Button Pins (using pullup resistors)
    pinMode(BTN_NEXT_PIN, INPUT_PULLUP);
    // ... Initialize PREV and PAUSE pins ...

    // Display welcome screen
    display.drawString("Deck Ready", 10, 10, 4);
}

// 2. Main Loop Logic
void loop() {
    // Check if the device is connected via Bluetooth
    if (bleKeyboard.isConnected()) {
        
        // --- Encoder (Volume Control) ---
        encoder.tick(); // Update encoder state
        int newPosition = encoder.getPosition();
        static int lastPosition = 0;

        if (newPosition != lastPosition) {
            if (newPosition > lastPosition) {
                // Volume Up (Turned Right)
                bleKeyboard.write(KEY_MEDIA_VOLUME_UP);
            } else {
                // Volume Down (Turned Left)
                bleKeyboard.write(KEY_MEDIA_VOLUME_DOWN);
            }
            display.updateVolumeBar(newPosition); // Function to update visual bar
            lastPosition = newPosition;
        }

        // --- Encoder Button (Play/Pause/Mute) ---
        if (digitalRead(ENCODER_SW_PIN) == LOW) { // Button is pressed
            // Debounce delay here
            bleKeyboard.write(KEY_MEDIA_PLAY_PAUSE);
            display.showIcon("PLAY / PAUSE");
        }

        // --- Dedicated Buttons (Next/Previous) ---
        if (digitalRead(BTN_NEXT_PIN) == LOW) {
            // Debounce delay here
            bleKeyboard.write(KEY_MEDIA_NEXT_TRACK);
            display.showIcon("NEXT");
        }
        // ... Logic for BTN_PREV and BTN_PAUSE ...

    } else {
        // Display "DISCONNECTED" on the screen
        display.drawString("Disconnected", 10, 50, 2);
    }
}
